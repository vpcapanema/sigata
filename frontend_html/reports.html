<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios - SIGATA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="sistema_aplicacao_cores_pli.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navegação -->
    <nav class="navbar navbar-expand-lg pli-navbar">
        <div class="container">
            <a class="navbar-brand pli-navbar-brand" href="index.html">
                <i class="fas fa-file-alt"></i> SIGATA
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Início
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="upload.html">
                            <i class="fas fa-upload"></i> Upload
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="documents.html">
                            <i class="fas fa-folder"></i> Documentos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="reports.html">
                            <i class="fas fa-chart-line"></i> Relatórios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="analytics.html">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Cabeçalho -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="section-title">
                        <i class="fas fa-chart-line text-pli-verde-principal"></i> 
                        <span class="text-pli-azul-escuro">Relatórios</span> 
                        <span class="text-pli-verde-principal">e Analytics</span>
                    </h1>
                    <div class="d-flex gap-2">
                        <button class="btn-pli-secondary" onclick="exportReport()">
                            <i class="fas fa-download"></i> Exportar PDF
                        </button>
                        <button class="btn-pli-institutional" onclick="refreshData()">
                            <i class="fas fa-sync"></i> Atualizar
                        </button>
                        <button class="btn-pli-confirm" onclick="generateReport()">
                            <i class="fas fa-file-pdf"></i> Gerar Relatório
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="pli-card-primary">
                    <h5 class="text-pli-azul-escuro mb-3">
                        <i class="fas fa-sliders-h"></i> Filtros de Relatório
                    </h5>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="periodFilter" class="form-label">Período</label>
                            <select class="form-select pli-select" id="periodFilter" onchange="updateReports()">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30" selected>Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                                <option value="365">Último ano</option>
                                <option value="all">Todos os períodos</option>
                            </select>
                        </div>
                <div class="col-md-3">
                    <label for="typeFilter" class="form-label">Tipo de Documento</label>
                    <select class="form-select" id="typeFilter" onchange="updateReports()">
                        <option value="">Todos os tipos</option>
                        <option value="ata_reuniao">Atas de Reunião</option>
                        <option value="documento_tecnico">Documentos Técnicos</option>
                        <option value="relatorio">Relatórios</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select class="form-select" id="statusFilter" onchange="updateReports()">
                        <option value="">Todos os status</option>
                        <option value="processado">Processados</option>
                        <option value="processando">Em processamento</option>
                        <option value="erro">Com erro</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="userFilter" class="form-label">Usuário</label>
                    <select class="form-select" id="userFilter" onchange="updateReports()">
                        <option value="">Todos os usuários</option>
                        <!-- Usuários serão carregados dinamicamente -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Métricas Principais -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalDocuments">0</div>
                    <div class="metric-label">Documentos Processados</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalSize">0 MB</div>
                    <div class="metric-label">Volume de Dados</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="avgProcessingTime">0min</div>
                    <div class="metric-label">Tempo Médio de Processamento</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">Taxa de Sucesso</div>
                </div>
            </div>
        </div>

        <!-- Seção de Relatórios Gerados -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="pli-card-primary">
                    <div class="card-header" style="background: var(--pli-azul-escuro); color: white;">
                        <h5 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>
                            Relatórios de Análise Gerados
                        </h5>
                        <small>Relatórios detalhados de documentos processados pelo SIGATA</small>
                    </div>
                    <div class="card-body">
                        <!-- Filtros específicos para relatórios -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="reportSearchFilter" class="form-label">Buscar Relatório</label>
                                <input type="text" class="form-control" id="reportSearchFilter" 
                                       placeholder="Nome do documento ou palavra-chave..." 
                                       onkeyup="filterReports()">
                            </div>
                            <div class="col-md-3">
                                <label for="reportDateFilter" class="form-label">Período de Geração</label>
                                <select class="form-select" id="reportDateFilter" onchange="filterReports()">
                                    <option value="">Todos os períodos</option>
                                    <option value="today">Hoje</option>
                                    <option value="week">Última semana</option>
                                    <option value="month">Último mês</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="reportTypeFilter" class="form-label">Tipo de Análise</label>
                                <select class="form-select" id="reportTypeFilter" onchange="filterReports()">
                                    <option value="">Todos os tipos</option>
                                    <option value="complete">Análise Completa</option>
                                    <option value="summary">Resumo Executivo</option>
                                    <option value="basic">Extração Básica</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-outline-secondary w-100" onclick="clearReportFilters()">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>

                        <!-- Tabela de Relatórios -->
                        <div class="table-responsive">
                            <table class="pli-table">
                                <thead>
                                    <tr>
                                        <th>Documento Original</th>
                                        <th>Data de Geração</th>
                                        <th>Tipo de Análise</th>
                                        <th>Participantes</th>
                                        <th>Decisões</th>
                                        <th>Ações</th>
                                        <th>Operações</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTable">
                                    <!-- Relatórios serão inseridos aqui pelo JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Estatísticas dos Relatórios -->
                        <div class="row mt-4">
                            <div class="col-md-3">
                                <div class="pli-card-metric text-center">
                                    <div class="pli-metric-icon">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <div class="pli-metric-value" id="totalReports">0</div>
                                    <div class="pli-metric-label">Relatórios Gerados</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="pli-card-metric text-center">
                                    <div class="pli-metric-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="pli-metric-value" id="totalParticipants">0</div>
                                    <div class="pli-metric-label">Participantes Identificados</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="pli-card-metric text-center">
                                    <div class="pli-metric-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="pli-metric-value" id="totalDecisions">0</div>
                                    <div class="pli-metric-label">Decisões Extraídas</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="pli-card-metric text-center">
                                    <div class="pli-metric-icon">
                                        <i class="fas fa-tasks"></i>
                                    </div>
                                    <div class="pli-metric-value" id="totalActions">0</div>
                                    <div class="pli-metric-label">Ações Identificadas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row">
            <!-- Gráfico de Uploads por Período -->
            <div class="col-md-6">
                <div class="report-section">
                    <h5><i class="fas fa-chart-line text-primary"></i> Uploads por Período</h5>
                    <div class="chart-container">
                        <canvas id="uploadsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Status dos Documentos -->
            <div class="col-md-6">
                <div class="report-section">
                    <h5><i class="fas fa-chart-pie text-primary"></i> Status dos Documentos</h5>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Gráfico de Tipos de Documento -->
            <div class="col-md-6">
                <div class="report-section">
                    <h5><i class="fas fa-chart-bar text-primary"></i> Tipos de Documento</h5>
                    <div class="chart-container">
                        <canvas id="typesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Atividade por Usuário -->
            <div class="col-md-6">
                <div class="report-section">
                    <h5><i class="fas fa-users text-primary"></i> Atividade por Usuário</h5>
                    <div class="chart-container">
                        <canvas id="usersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Relatórios Detalhados -->
        <div class="row">
            <div class="col-12">
                <div class="report-section">
                    <h5><i class="fas fa-table text-primary"></i> Análise Detalhada</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Documento</th>
                                    <th>Tipo</th>
                                    <th>Tamanho</th>
                                    <th>Status</th>
                                    <th>Tempo Processamento</th>
                                    <th>Entidades Extraídas</th>
                                    <th>Usuário</th>
                                    <th>Data Upload</th>
                                </tr>
                            </thead>
                            <tbody id="detailedReportTable">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights e Recomendações -->
        <div class="row">
            <div class="col-12">
                <div class="report-section">
                    <h5><i class="fas fa-lightbulb text-primary"></i> Insights e Recomendações</h5>
                    <div id="insightsContainer">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Analisando dados...</span>
                            </div>
                            <p class="mt-2">Gerando insights baseados nos dados...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/data-manager.js"></script>
    <script>
        let documentsData = [];
        let charts = {};

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadReportData();
        });

        async function loadReportData() {
            try {
                // Carregar dados dos documentos
                const docsResponse = await fetch('http://localhost:3001/documents/');
                if (docsResponse.ok) {
                    documentsData = await docsResponse.json();
                }

                // Carregar usuários para o filtro
                const usersResponse = await fetch('http://localhost:3001/api/usuarios');
                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    populateUserFilter(users);
                }

                updateReports();
            } catch (error) {
                console.error('Erro ao carregar dados do relatório:', error);
                showError('Erro ao carregar dados. Verifique a conexão.');
            }
        }

        function populateUserFilter(users) {
            const userFilter = document.getElementById('userFilter');
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.nome_completo || user.username;
                userFilter.appendChild(option);
            });
        }

        // ==========================================
        // RELATÓRIOS - SIGATA
        // ==========================================

        let reportsData = [];
        let filteredReports = [];

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
        });

        async function initializePage() {
            try {
                // Verificar autenticação

                await loadReports();
                await loadUsers();
                updateReportsTable();
                updateStatistics();
            } catch (error) {
                console.error('Erro ao inicializar página:', error);
                dataManager.showNotification('danger', 'Erro ao carregar dados dos relatórios.');
            }
        }

        function setupEventListeners() {
            document.getElementById('searchFilter').addEventListener('input', filterReports);
            document.getElementById('typeFilter').addEventListener('change', filterReports);
            document.getElementById('userFilter').addEventListener('change', filterReports);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
        }

        // ========== CARREGAMENTO DE DADOS ==========
        async function loadReports() {
            try {
                // Carregar análises que possuem relatórios gerados
                const analyses = await dataManager.loadAnalyses({ 
                    status: 'completed',
                    include_document: true 
                });
                
                reportsData = analyses.map(analysis => ({
                    id: analysis.id,
                    documentId: analysis.document_id,
                    documentName: analysis.document?.original_name || 'Documento não encontrado',
                    generationDate: analysis.completed_at || analysis.created_at,
                    analysisType: analysis.analysis_type || 'basic',
                    participants: analysis.results?.participants?.length || 0,
                    decisions: analysis.results?.decisions?.length || 0,
                    actions: analysis.results?.actions?.length || 0,
                    sentiment: analysis.results?.sentiment_analysis?.overall_sentiment || 'neutral',
                    analysis: analysis
                }));

                filteredReports = [...reportsData];
            } catch (error) {
                console.error('Erro ao carregar relatórios:', error);
                dataManager.showNotification('danger', 'Erro ao carregar relatórios do servidor.');
            }
        }

        // ========== ATUALIZAÇÃO DA INTERFACE ==========
        function updateReportsTable() {
            const tbody = document.getElementById('reportsTable');
            tbody.innerHTML = '';
            
            if (filteredReports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>Nenhum relatório encontrado</p>
                        </td>
                    </tr>
                `;
                return;
            }

            filteredReports.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <i class="fas fa-file-alt text-primary me-2"></i>
                        ${report.documentName}
                    </td>
                    <td>${dataManager.formatDate(report.generationDate)}</td>
                    <td>${getAnalysisTypeLabel(report.analysisType)}</td>
                    <td class="text-center">${report.participants}</td>
                    <td class="text-center">${report.decisions}</td>
                    <td class="text-center">${report.actions}</td>
                    <td>${getReportActions(report)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStatistics() {
            const total = filteredReports.length;
            const totalParticipants = filteredReports.reduce((sum, r) => sum + r.participants, 0);
            const totalDecisions = filteredReports.reduce((sum, r) => sum + r.decisions, 0);
            const totalActions = filteredReports.reduce((sum, r) => sum + r.actions, 0);

            document.getElementById('totalReports').textContent = total;
            document.getElementById('totalParticipants').textContent = totalParticipants;
            document.getElementById('totalDecisions').textContent = totalDecisions;
            document.getElementById('totalActions').textContent = totalActions;
        }

        // ========== FILTROS ==========
        function filterReports() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const userFilter = document.getElementById('userFilter').value;

            filteredReports = reportsData.filter(report => {
                // Filtro de busca
                if (searchTerm && !report.documentName.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Filtro de tipo
                if (typeFilter && report.analysisType !== typeFilter) {
                    return false;
                }

                // Filtro de usuário (se necessário)
                if (userFilter && report.userId && report.userId !== userFilter) {
                    return false;
                }

                return true;
            });

            updateReportsTable();
            updateStatistics();
        }

        function clearFilters() {
            document.getElementById('searchFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('userFilter').value = '';
            filteredReports = [...reportsData];
            updateReportsTable();
            updateStatistics();
        }

        // ========== UTILITÁRIOS ==========
        function getAnalysisTypeLabel(type) {
            const labels = {
                'complete': 'Análise Completa',
                'summary': 'Resumo Executivo',
                'basic': 'Extração Básica',
                'advanced': 'Análise Avançada'
            };
            return labels[type] || 'Desconhecido';
        }

        function getAnalysisTypeColor(type) {
            const colors = {
                'complete': 'success',
                'summary': 'primary',
                'basic': 'secondary',
                'advanced': 'info'
            };
            return colors[type] || 'secondary';
        }

        function getReportActions(report) {
            return `
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" onclick="viewGeneratedReport('${report.id}')" title="Visualizar Relatório">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="downloadGeneratedReport('${report.id}')" title="Baixar PDF">
                        <i class="fas fa-file-download"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="shareReport('${report.id}')" title="Compartilhar">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
            `;
        }

        function getAnalysisTypeColor(type) {
            const colors = {
                'complete': 'success',
                'summary': 'primary',
                'basic': 'secondary'
            };
            return colors[type] || 'secondary';
        }

        function getAnalysisTypeLabel(type) {
            const labels = {
                'complete': 'Análise Completa',
                'summary': 'Resumo Executivo',
                'basic': 'Extração Básica'
            };
            return labels[type] || 'Indefinido';
        }

        function updateReportStats() {
            document.getElementById('totalReports').textContent = filteredReports.length;
            document.getElementById('totalParticipants').textContent = 
                filteredReports.reduce((sum, report) => sum + report.participants, 0);
            document.getElementById('totalDecisions').textContent = 
                filteredReports.reduce((sum, report) => sum + report.decisions, 0);
            document.getElementById('totalActions').textContent = 
                filteredReports.reduce((sum, report) => sum + report.actions, 0);
        }

        function filterReports() {
            const searchTerm = document.getElementById('reportSearchFilter').value.toLowerCase();
            const dateFilter = document.getElementById('reportDateFilter').value;
            const typeFilter = document.getElementById('reportTypeFilter').value;

            filteredReports = mockReports.filter(report => {
                // Filtro de busca
                if (searchTerm && !report.documentName.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Filtro de data
                if (dateFilter) {
                    const reportDate = new Date(report.generationDate);
                    const now = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            if (reportDate.toDateString() !== now.toDateString()) return false;
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (reportDate < weekAgo) return false;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            if (reportDate < monthAgo) return false;
                            break;
                    }
                }

                // Filtro de tipo
                if (typeFilter && report.analysisType !== typeFilter) {
                    return false;
                }

                return true;
            });

            populateReportsTable();
            updateReportStats();
        }

        function clearReportFilters() {
            document.getElementById('reportSearchFilter').value = '';
            document.getElementById('reportDateFilter').value = '';
            document.getElementById('reportTypeFilter').value = '';
            filteredReports = [...mockReports];
            populateReportsTable();
            updateReportStats();
        }

        function viewGeneratedReport(id) {
            const report = mockReports.find(r => r.id === id);
            if (report) {
                window.open(report.reportUrl, '_blank');
                showSuccessMessage(`Relatório de "${report.documentName}" aberto em nova aba.`);
            }
        }

        function downloadGeneratedReport(id) {
            const report = mockReports.find(r => r.id === id);
            if (report) {
                // Simular download
                const link = document.createElement('a');
                link.href = report.reportUrl;
                link.download = `SIGATA_Relatorio_${report.documentName.replace(/\.[^/.]+$/, "")}_${report.generationDate}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccessMessage(`Relatório de "${report.documentName}" foi baixado.`);
            }
        }

        function shareReport(id) {
            const report = mockReports.find(r => r.id === id);
            if (report) {
                const url = `${window.location.origin}/${report.reportUrl}`;
                navigator.clipboard.writeText(url).then(() => {
                    showSuccessMessage('Link do relatório copiado para a área de transferência!');
                }).catch(() => {
                    showErrorMessage('Erro ao copiar link. Tente novamente.');
                });
            }
        }

        function showSuccessMessage(message) {
            showToast('success', message);
        }

        function showErrorMessage(message) {
            showToast('danger', message);
        }

        function showToast(type, message) {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 mb-2`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '1055';
            document.body.appendChild(container);
            return container;
        }

        function updateReports() {
            const filteredData = applyFilters(documentsData);
            
            updateMetrics(filteredData);
            updateCharts(filteredData);
            updateDetailedTable(filteredData);
            generateInsights(filteredData);
            
            // Atualizar também os relatórios
            populateReportsTable();
            updateReportStats();
        }

        function applyFilters(data) {
            const period = document.getElementById('periodFilter').value;
            const type = document.getElementById('typeFilter').value;
            const status = document.getElementById('statusFilter').value;
            const user = document.getElementById('userFilter').value;

            return data.filter(doc => {
                // Filtro de período
                if (period !== 'all') {
                    const docDate = new Date(doc.data_upload);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - parseInt(period));
                    if (docDate < cutoffDate) return false;
                }

                // Filtro de tipo
                if (type && doc.tipo_documento !== type) return false;

                // Filtro de status
                if (status && doc.status !== status) return false;

                // Filtro de usuário
                if (user && doc.usuario_upload_id !== user) return false;

                return true;
            });
        }

        function updateMetrics(data) {
            const totalSize = data.reduce((sum, doc) => sum + (doc.tamanho_arquivo || 0), 0);
            const processedDocs = data.filter(doc => doc.status === 'processado');
            const successRate = data.length > 0 ? (processedDocs.length / data.length) * 100 : 0;

            document.getElementById('totalDocuments').textContent = data.length;
            document.getElementById('totalSize').textContent = formatFileSize(totalSize);
            document.getElementById('avgProcessingTime').textContent = calculateAvgProcessingTime(data);
            document.getElementById('successRate').textContent = successRate.toFixed(1) + '%';
        }

        function updateCharts(data) {
            createUploadsChart(data);
            createStatusChart(data);
            createTypesChart(data);
            createUsersChart(data);
        }

        function createUploadsChart(data) {
            const ctx = document.getElementById('uploadsChart').getContext('2d');
            
            // Agrupar por data
            const uploadsPerDay = {};
            data.forEach(doc => {
                const date = new Date(doc.data_upload).toLocaleDateString('pt-BR');
                uploadsPerDay[date] = (uploadsPerDay[date] || 0) + 1;
            });

            const labels = Object.keys(uploadsPerDay).sort();
            const values = labels.map(label => uploadsPerDay[label]);

            if (charts.uploads) charts.uploads.destroy();
            
            charts.uploads = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Uploads por Dia',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createStatusChart(data) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            const statusCount = {};
            data.forEach(doc => {
                statusCount[doc.status] = (statusCount[doc.status] || 0) + 1;
            });

            const labels = Object.keys(statusCount);
            const values = Object.values(statusCount);
            const colors = ['#28a745', '#ffc107', '#dc3545', '#6c757d'];

            if (charts.status) charts.status.destroy();
            
            charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(status => getStatusLabel(status)),
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createTypesChart(data) {
            const ctx = document.getElementById('typesChart').getContext('2d');
            
            const typeCount = {};
            data.forEach(doc => {
                const type = doc.tipo_documento || 'outros';
                typeCount[type] = (typeCount[type] || 0) + 1;
            });

            const labels = Object.keys(typeCount);
            const values = Object.values(typeCount);

            if (charts.types) charts.types.destroy();
            
            charts.types = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(type => getTypeLabel(type)),
                    datasets: [{
                        label: 'Quantidade',
                        data: values,
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createUsersChart(data) {
            const ctx = document.getElementById('usersChart').getContext('2d');
            
            const userCount = {};
            data.forEach(doc => {
                const user = doc.usuario_nome || 'Sistema';
                userCount[user] = (userCount[user] || 0) + 1;
            });

            const labels = Object.keys(userCount);
            const values = Object.values(userCount);

            if (charts.users) charts.users.destroy();
            
            charts.users = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Documentos Enviados',
                        data: values,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateDetailedTable(data) {
            const tbody = document.getElementById('detailedReportTable');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum documento encontrado para os filtros selecionados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(doc => `
                <tr>
                    <td>
                        <i class="fas fa-file-alt text-primary me-2"></i>
                        ${doc.nome_arquivo}
                    </td>
                    <td><span class="badge bg-secondary">${getTypeLabel(doc.tipo_documento)}</span></td>
                    <td>${formatFileSize(doc.tamanho_arquivo || 0)}</td>
                    <td><span class="badge ${getStatusBadgeClass(doc.status)}">${getStatusLabel(doc.status)}</span></td>
                    <td>${calculateProcessingTime(doc)}</td>
                    <td>${doc.entidades_count || 0}</td>
                    <td>${doc.usuario_nome || 'Sistema'}</td>
                    <td>${formatDate(doc.data_upload)}</td>
                </tr>
            `).join('');
        }

        function generateInsights(data) {
            const insights = [];
            
            if (data.length === 0) {
                insights.push({
                    type: 'info',
                    title: 'Nenhum Dado Disponível',
                    description: 'Não há documentos para o período selecionado.'
                });
            } else {
                // Análise de performance
                const successRate = (data.filter(d => d.status === 'processado').length / data.length) * 100;
                if (successRate < 80) {
                    insights.push({
                        type: 'warning',
                        title: 'Taxa de Sucesso Baixa',
                        description: `Apenas ${successRate.toFixed(1)}% dos documentos foram processados com sucesso. Considere revisar os arquivos com erro.`
                    });
                }

                // Análise de volume
                const avgPerDay = data.length / 30;
                if (avgPerDay > 10) {
                    insights.push({
                        type: 'success',
                        title: 'Alto Volume de Processamento',
                        description: `Média de ${avgPerDay.toFixed(1)} documentos processados por dia. Sistema operando com boa capacidade.`
                    });
                }

                // Análise de tipos
                const typeCount = {};
                data.forEach(doc => {
                    const type = doc.tipo_documento || 'outros';
                    typeCount[type] = (typeCount[type] || 0) + 1;
                });
                const mostCommonType = Object.keys(typeCount).reduce((a, b) => typeCount[a] > typeCount[b] ? a : b);
                insights.push({
                    type: 'info',
                    title: 'Tipo Mais Comum',
                    description: `${getTypeLabel(mostCommonType)} representa ${((typeCount[mostCommonType] / data.length) * 100).toFixed(1)}% dos documentos processados.`
                });
            }

            displayInsights(insights);
        }

        function displayInsights(insights) {
            const container = document.getElementById('insightsContainer');
            
            container.innerHTML = insights.map(insight => `
                <div class="alert alert-${insight.type === 'warning' ? 'warning' : insight.type === 'success' ? 'success' : 'info'}" role="alert">
                    <h6><i class="fas fa-lightbulb"></i> ${insight.title}</h6>
                    <p class="mb-0">${insight.description}</p>
                </div>
            `).join('');
        }

        // Funções auxiliares
        function getStatusLabel(status) {
            switch (status) {
                case 'processado': return 'Processado';
                case 'processando': return 'Processando';
                case 'erro': return 'Erro';
                case 'pendente': return 'Pendente';
                default: return 'Desconhecido';
            }
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'processado': return 'bg-success';
                case 'processando': return 'bg-warning';
                case 'erro': return 'bg-danger';
                case 'pendente': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function getTypeLabel(type) {
            switch (type) {
                case 'ata_reuniao': return 'Ata de Reunião';
                case 'documento_tecnico': return 'Documento Técnico';
                case 'relatorio': return 'Relatório';
                case 'outros': return 'Outros';
                default: return 'Não definido';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function calculateAvgProcessingTime(data) {
            const processedDocs = data.filter(doc => doc.data_processamento && doc.data_upload);
            if (processedDocs.length === 0) return '0min';
            
            const totalTime = processedDocs.reduce((sum, doc) => {
                const uploadTime = new Date(doc.data_upload);
                const processTime = new Date(doc.data_processamento);
                return sum + (processTime - uploadTime);
            }, 0);
            
            const avgTime = totalTime / processedDocs.length;
            const minutes = Math.round(avgTime / (1000 * 60));
            return minutes + 'min';
        }

        function calculateProcessingTime(doc) {
            if (!doc.data_processamento || !doc.data_upload) return 'N/A';
            
            const uploadTime = new Date(doc.data_upload);
            const processTime = new Date(doc.data_processamento);
            const diffMinutes = Math.round((processTime - uploadTime) / (1000 * 60));
            return diffMinutes + 'min';
        }

    </script>

    <!-- Footer PLI -->
    <footer class="pli-footer py-4 mt-5">
        <div class="container text-center">
            <div>SIGATA &copy; 2025 - Sistema Integrado de Gestão de Atas</div>
            <div>Desenvolvido e implementado por VPC-GEOSER</div>
            <div>18/07/2025</div>
        </div>
    </footer>
</body>
</html>
