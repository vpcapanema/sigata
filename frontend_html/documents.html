<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentos - SIGATA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="sistema_aplicacao_cores_pli.css" rel="stylesheet">
    <style>
        /* Estilos customizados para página de documentos */
        .page-title {
            color: var(--pli-azul-escuro);
        }
        
        .card-header-custom {
            background: var(--pli-azul-escuro);
            color: white;
        }
        
        .table-documents {
            border: 2px solid #000;
        }
        
        .table-documents thead {
            background: var(--pli-azul-escuro);
            color: white;
        }
        
        .table-documents th,
        .table-documents td {
            border: 1px solid #6c757d;
        }
        
        .table-documents tbody {
            border: 1px solid #6c757d;
        }
        
        .table-responsive {
            overflow-x: auto;
            max-width: 100%;
            width: 100%;
        }
        
        .table-documents {
            width: 100%;
            min-width: 1500px; /* Forçar largura mínima para garantir espaço para todas as colunas */
        }
        
        .table-documents th,
        .table-documents td {
            white-space: nowrap;
            min-width: 120px;
            padding: 8px 12px;
        }
    </style>
</head>
<body>
    <!-- Navegação -->
    <nav class="navbar navbar-expand-lg pli-navbar">
        <div class="container">
            <a class="navbar-brand pli-navbar-brand" href="index.html">
                <i class="fas fa-file-alt"></i> SIGATA
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Início
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="upload.html">
                            <i class="fas fa-upload"></i> Upload
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="documents.html">
                            <i class="fas fa-folder"></i> Documentos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <i class="fas fa-chart-line"></i> Relatórios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="analytics.html">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row">
            <div class="col-12">
                <!-- Cabeçalho da Página -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h2 page-title">
                        <i class="fas fa-folder me-2"></i>
                        Documentos Processados
                    </h1>
                    <div class="d-flex gap-2">
                        <button class="btn pli-button" onclick="refreshDocuments()">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                        <a href="upload.html" class="btn pli-button">
                            <i class="fas fa-plus me-1"></i>Novo Upload
                        </a>
                    </div>
                </div>

                <!-- Cards Estatísticos -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="pli-card-metric">
                            <div class="pli-metric-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="pli-metric-value" id="totalDocs">15</div>
                            <div class="pli-metric-label">Total de Documentos</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="pli-card-metric">
                            <div class="pli-metric-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="pli-metric-value text-success" id="processedDocs">12</div>
                            <div class="pli-metric-label">Processados</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="pli-card-metric">
                            <div class="pli-metric-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="pli-metric-value text-warning" id="pendingDocs">2</div>
                            <div class="pli-metric-label">Pendentes</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="pli-card-metric">
                            <div class="pli-metric-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="pli-metric-value text-danger" id="errorDocs">1</div>
                            <div class="pli-metric-label">Com Erro</div>
                        </div>
                    </div>
                </div>

                <!-- Seção de Controle e Visualização de Documentos -->
                <div class="pli-card-primary mb-4" style="max-width: 100%; overflow-x: auto;">
                    <div class="card-header card-header-custom">
                        <h5 class="mb-0">
                            <i class="fas fa-list-alt me-2"></i>
                            Controle e Visualização de Documentos
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <input type="text" class="form-control pli-input" id="searchFilter" placeholder="Buscar documentos...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select pli-select" id="typeFilter" title="Selecionar Tipo">
                                    <option value="">Todos os tipos</option>
                                    <option value="pdf">PDF</option>
                                    <option value="docx">Word</option>
                                    <option value="txt">Texto</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select pli-select" id="statusFilter" title="Selecionar Status">
                                    <option value="">Todos os status</option>
                                    <option value="processado">Processado</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="erro">Erro</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" id="clearFilters">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>

                        <!-- Lista de Documentos -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-documents">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Arquivo</th>
                                        <th>Tipo</th>
                                        <th>Descrição</th>
                                        <th>Data Upload</th>
                                        <th>Status</th>
                                        <th>Usuário Upload</th>
                                        <th>Início do Processamento</th>
                                        <th>Fim do Processamento</th>
                                        <th>Data da Atualização</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="documentsTable">
                                    <!-- Documentos serão inseridos aqui pelo JavaScript -->
                                    <!-- Exemplo de linha dinâmica:
                                    <tr>
                                        <td>{{codigo}}</td>
                                        <td>{{nome_arquivo}}</td>
                                        <td>{{tipo}}</td>
                                        <td>{{descricao}}</td>
                                        <td>{{data_upload}}</td>
                                        <td>{{status}}</td>
                                        <td>{{inicio_processamento}}</td>
                                        <td>{{fim_processamento}}</td>
                                        <td>{{usuario_responsavel_upload}}</td>
                                        <td>
                                            <button class="btn btn-sm pli-button" title="Visualizar" onclick="viewDocument('{{codigo}}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm pli-button" title="Baixar" onclick="downloadDocument('{{codigo}}')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" title="Excluir" onclick="deleteDocument('{{codigo}}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Ação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" title="Fechar" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmAction">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer PLI -->
    <footer class="pli-footer py-4 mt-5">
        <div class="container text-center">
            <div>SIGATA &copy; 2025 - Sistema Integrado de Gestão de Atas</div>
            <div>Desenvolvido e implementado por VPC-GEOSER</div>
            <div>18/07/2025</div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/data-manager.js"></script>
    <script>
        // ==========================================
        // GERENCIAMENTO DE DOCUMENTOS - SIGATA
        // ==========================================

        let documentsData = [];
        let filteredDocuments = [];

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
        });

        async function initializePage() {
            try {
                await loadDocuments();
                updateDocumentsTable();
                updateStatistics();
            } catch (error) {
                console.error('Erro ao inicializar página:', error);
                dataManager.showNotification('danger', 'Erro ao carregar dados. Verifique sua conexão.');
            }
        }

        function setupEventListeners() {
            document.getElementById('searchFilter').addEventListener('input', filterDocuments);
            document.getElementById('typeFilter').addEventListener('change', filterDocuments);
            document.getElementById('statusFilter').addEventListener('change', filterDocuments);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
        }

        // ========== CARREGAMENTO DE DADOS ==========
        async function loadDocuments() {
            try {
                documentsData = await dataManager.loadDocuments();
                filteredDocuments = [...documentsData];
            } catch (error) {
                console.error('Erro ao carregar documentos:', error);
                dataManager.showNotification('danger', 'Erro ao carregar documentos do servidor.');
            }
        }

        async function refreshDocuments() {
            try {
                dataManager.clearCache('documents_{}');
                await loadDocuments();
                updateDocumentsTable();
                updateStatistics();
                dataManager.showNotification('success', 'Documentos atualizados com sucesso!');
            } catch (error) {
                console.error('Erro ao atualizar documentos:', error);
                dataManager.showNotification('danger', 'Erro ao atualizar documentos.');
            }
        }

        // ========== ATUALIZAÇÃO DA INTERFACE ==========
        function updateDocumentsTable() {
            const tbody = document.getElementById('documentsTable');
            tbody.innerHTML = '';

            if (filteredDocuments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>Nenhum documento encontrado</p>
                        </td>
                    </tr>
                `;
                return;
            }

            filteredDocuments.forEach(doc => {
                // Nenhum log necessário
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${doc.codigo_documento || '-'}</td>
                    <td>${doc.nome_arquivo || '-'}</td>
                    <td>${doc.tipo_documento || '-'}</td>
                    <td>${doc.descricao || '-'}</td>
                    <td>${doc.data_upload ? dataManager.formatDate(doc.data_upload) : '-'}</td>
                    <td>${dataManager.getStatusBadge(doc.status_documento)}</td>
                    <td>${doc.usuario_upload_username || '-'}</td>
                    <td>${doc.data_inicio_processamento ? dataManager.formatDate(doc.data_inicio_processamento) : '-'}</td>
                    <td>${doc.data_fim_processamento ? dataManager.formatDate(doc.data_fim_processamento) : '-'}</td>
                    <td>${doc.data_atualizacao ? dataManager.formatDate(doc.data_atualizacao) : '-'}</td>
                    <td>${getDocumentActions(doc)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStatistics() {
            const total = filteredDocuments.length;
            const processed = filteredDocuments.filter(doc => doc.status_documento === 'CONCLUIDO').length;
            const pending = filteredDocuments.filter(doc => doc.status_documento === 'PROCESSANDO' || doc.status_documento === 'PENDENTE').length;
            const error = filteredDocuments.filter(doc => doc.status_documento === 'ERRO' || doc.status_documento === 'REJEITADO').length;

            document.getElementById('totalDocs').textContent = total;
            document.getElementById('processedDocs').textContent = processed;
            document.getElementById('pendingDocs').textContent = pending;
            document.getElementById('errorDocs').textContent = error;
        }

        // ========== FILTROS ==========
        function filterDocuments() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredDocuments = documentsData.filter(doc => {
                // Filtro de busca
                if (searchTerm && !(doc.nome_arquivo && doc.nome_arquivo.toLowerCase().includes(searchTerm))) {
                    return false;
                }

                // Filtro de tipo
                if (typeFilter) {
                    const fileType = doc.tipo_documento ? doc.tipo_documento.toLowerCase() : '';
                    if (fileType !== typeFilter) return false;
                }

                // Filtro de status
                if (statusFilter) {
                    const mappedStatus = mapStatusToFilter(doc.status_documento);
                    if (mappedStatus !== statusFilter) return false;
                }

                return true;
            });

            updateDocumentsTable();
            updateStatistics();
        }

        function clearFilters() {
            document.getElementById('searchFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filteredDocuments = [...documentsData];
            updateDocumentsTable();
            updateStatistics();
        }

        // ========== UTILITÁRIOS ==========
        function getFileTypeLabel(mimetype) {
            if (mimetype.includes('pdf')) return 'PDF';
            if (mimetype.includes('word')) return 'DOCX';
            if (mimetype.includes('text')) return 'TXT';
            return 'Outro';
        }

        function getFileTypeFromMimetype(mimetype) {
            if (mimetype.includes('pdf')) return 'pdf';
            if (mimetype.includes('word')) return 'docx';
            if (mimetype.includes('text')) return 'txt';
            return 'other';
        }

        function mapStatusToFilter(status) {
            const statusMap = {
                'CONCLUIDO': 'processado',
                'PROCESSANDO': 'pendente',
                'PENDENTE': 'pendente',
                'ERRO': 'erro',
                'REJEITADO': 'erro'
            };
            return statusMap[status] || status;
        }

        function getReportActions(doc) {
            if (doc.status_documento === 'completed') {
                return `
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-primary btn-sm" onclick="viewReport('${doc.codigo_documento}')" title="Ver Relatório">
                            <i class="fas fa-chart-bar me-1"></i>Ver
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="downloadReport('${doc.codigo_documento}')" title="Baixar Relatório">
                            <i class="fas fa-file-download me-1"></i>PDF
                        </button>
                    </div>
                `;
            } else if (doc.status_documento === 'processing') {
                return '<span class="text-muted small">Processando...</span>';
            } else {
                return '<span class="text-muted small">Indisponível</span>';
            }
        }

        function getDocumentActions(doc) {
            return `
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" onclick="viewDocument('${doc.codigo_documento}')" title="Visualizar">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="downloadDocument('${doc.codigo_documento}')" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                    ${doc.status_documento === 'uploaded' ? 
                        `<button class="btn btn-outline-primary" onclick="processDocument('${doc.codigo_documento}')" title="Processar">
                            <i class="fas fa-cog"></i>
                        </button>` : ''}
                    <button class="btn btn-outline-success" onclick="reprocessDocument('${doc.codigo_documento}')" title="Reprocessar">
                        <i class="fas fa-sync"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteDocument('${doc.codigo_documento}')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        // ========== AÇÕES DOS DOCUMENTOS ==========
        async function viewReport(documentId) {
            try {
                // Buscar análise do documento
                const analyses = await dataManager.loadAnalyses({ document_id: documentId });
                if (analyses && analyses.length > 0) {
                    const analysis = analyses[0];
                    // Abrir relatório baseado na análise
                    window.open(`/reports/${analysis.id}/view`, '_blank');
                    dataManager.showNotification('success', 'Relatório aberto em nova aba.');
                } else {
                    dataManager.showNotification('warning', 'Nenhuma análise encontrada para este documento.');
                }
            } catch (error) {
                console.error('Erro ao visualizar relatório:', error);
                dataManager.showNotification('danger', 'Erro ao carregar relatório.');
            }
        }

        async function downloadReport(documentId) {
            try {
                const analyses = await dataManager.loadAnalyses({ document_id: documentId });
                if (analyses && analyses.length > 0) {
                    const analysis = analyses[0];
                    // Baixar relatório
                    const reportData = await sigataAPI.downloadReport(analysis.id);
                    // Simular download
                    const blob = new Blob([reportData], { type: 'text/html' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `SIGATA_Relatorio_${documentId}_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    dataManager.showNotification('success', 'Relatório baixado com sucesso.');
                } else {
                    dataManager.showNotification('warning', 'Nenhuma análise encontrada para este documento.');
                }
            } catch (error) {
                console.error('Erro ao baixar relatório:', error);
                dataManager.showNotification('danger', 'Erro ao baixar relatório.');
            }
        }

        async function viewDocument(documentId) {
            try {
                // Buscar detalhes completos do documento da view do banco
                // Como o endpoint /documents/:id/details não existe, vamos usar o endpoint /documents/full-view
                // e filtrar o documento específico
                const response = await sigataAPI.request('/documents/full-view');
                
                if (response && response.success) {
                    // Filtrar o documento específico
                    const document = response.documents.find(doc => doc.codigo_documento === documentId);
                    
                    if (!document) {
                        dataManager.showNotification('warning', 'Documento não encontrado.');
                        return;
                    }
                    
                    // Criar objeto de resposta no formato esperado
                    const documentResponse = {
                        success: true,
                        document: document
                    };
                    // Criar uma janela modal para exibir os detalhes
                    const modalContent = document.createElement('div');
                    modalContent.innerHTML = `
                        <div class="modal fade" id="documentViewModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header pli-modal-header">
                                        <h5 class="modal-title">Detalhes do Documento: ${documentResponse.document.nome_arquivo || 'Sem nome'}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="table-responsive">
                                            <table class="table table-bordered">
                                                <tbody>
                                                    ${Object.entries(documentResponse.document).map(([key, value]) => `
                                                        <tr>
                                                            <th>${key}</th>
                                                            <td>${value !== null ? value : '-'}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modalContent);
                    const modal = new bootstrap.Modal(document.getElementById('documentViewModal'));
                    modal.show();
                    
                    // Remover o modal do DOM quando for fechado
                    document.getElementById('documentViewModal').addEventListener('hidden.bs.modal', function () {
                        document.body.removeChild(modalContent);
                    });
                } else {
                    dataManager.showNotification('warning', 'Não foi possível carregar os detalhes do documento.');
                }
            } catch (error) {
                console.error('Erro ao abrir visualização completa:', error);
                dataManager.showNotification('danger', 'Erro ao abrir visualização do documento.');
            }
        }

        async function downloadDocument(documentId) {
            try {
                // Fazer download do binário do arquivo armazenado na coluna arquivo_binario
                const doc = documentsData.find(d => d.codigo_documento === documentId);
                if (!doc) {
                    dataManager.showNotification('warning', 'Documento não encontrado.');
                    return;
                }
                
                dataManager.showNotification('info', 'Iniciando download do documento...');
                
                // Como o endpoint /documents/:id/download não existe, informamos ao usuário
                dataManager.showNotification('warning', 'Funcionalidade de download não implementada no backend.');
                return;
                
                /* O código abaixo seria usado se o endpoint existisse
                const response = await fetch(sigataAPI.baseURL + '/documents/' + documentId + '/download', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ao baixar documento: ${response.status}`);
                }
                
                // Obter o blob do arquivo
                const blob = await response.blob();
                
                // Criar um link para download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = doc.nome_arquivo || `documento_${documentId}.${doc.tipo_documento?.toLowerCase() || 'bin'}`;
                document.body.appendChild(a);
                a.click();
                
                // Limpar
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                dataManager.showNotification('success', 'Download iniciado com sucesso!');
                */
            } catch (error) {
                console.error('Erro ao baixar documento:', error);
                dataManager.showNotification('danger', 'Erro ao baixar documento. Verifique se o arquivo existe no servidor.');
            }
        }

        async function processDocument(documentId) {
            const doc = documentsData.find(d => d.codigo_documento === documentId);
            if (!doc) return;

            if (confirm(`Deseja processar o documento "${doc.nome_arquivo}"?`)) {
                try {
                    // Mostrar notificação de processamento
                    dataManager.showNotification('info', `Iniciando processamento do documento...`);
                    
                    // Usar o endpoint correto do API_CONFIG
                    const endpoint = API_CONFIG.ENDPOINTS.DOCUMENTS_PROCESS.replace(':id', documentId);
                    
                    // Preparar dados para envio
                    const requestData = {
                        model: 'gpt-4',  // Modelo padrão
                        detailLevel: 'complete',  // Nível de detalhe padrão
                        forceReprocess: false  // Processamento normal
                    };
                    
                    // Log para debug
                    console.log(`Processando documento ${documentId} com endpoint: ${endpoint}`, requestData);
                    
                    // Fazer a requisição
                    const response = await fetch(sigataAPI.baseURL + endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMessage = 'Erro ao iniciar processamento';
                        
                        try {
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.error || errorMessage;
                        } catch (e) {
                            errorMessage = errorText || errorMessage;
                        }
                        
                        throw new Error(errorMessage);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Atualizar status localmente
                        doc.status_documento = 'PROCESSANDO';
                        updateDocumentsTable();
                        updateStatistics();
                        
                        dataManager.showNotification('success', `Processamento iniciado para "${doc.nome_arquivo}".`);
                        
                        // Atualizar a lista após um tempo
                        setTimeout(() => {
                            refreshDocuments();
                        }, 5000);
                    } else {
                        throw new Error(result.error || 'Erro desconhecido ao iniciar processamento');
                    }
                } catch (error) {
                    console.error('Erro ao processar documento:', error);
                    dataManager.showNotification('danger', `Erro ao iniciar processamento: ${error.message}`);
                }
            }
        }

        async function deleteDocument(documentId) {
            const doc = documentsData.find(d => d.codigo_documento === documentId);
            if (!doc) return;

            // Criar modal para confirmação com senha
            const modalContent = document.createElement('div');
            modalContent.innerHTML = `
                <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header pli-modal-header">
                                <h5 class="modal-title">Confirmar Exclusão</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                <p>Você está prestes a excluir o documento:</p>
                                <p><strong>${doc.nome_arquivo}</strong></p>
                                <p>Esta ação não pode ser desfeita e requer confirmação de senha.</p>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Apenas usuários do tipo ADMIN, GESTOR ou ANALISTA podem excluir documentos.
                                </div>
                                <div class="form-group mb-3">
                                    <label for="deletePassword" class="form-label">Digite sua senha para confirmar:</label>
                                    <input type="password" class="form-control" id="deletePassword" placeholder="Senha">
                                </div>
                                <div id="deleteErrorMessage" class="text-danger"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                                    <i class="fas fa-trash me-1"></i>Excluir Documento
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalContent);
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
            
            // Configurar o botão de confirmação
            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                const password = document.getElementById('deletePassword').value;
                const errorElement = document.getElementById('deleteErrorMessage');
                
                if (!password) {
                    errorElement.textContent = 'Por favor, digite sua senha.';
                    return;
                }
                
                try {
                    // Enviar solicitação de exclusão com senha para verificação
                    const response = await fetch(sigataAPI.baseURL + '/documents/' + documentId, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({ password })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Fechar o modal
                        modal.hide();
                        
                        // Remover da lista local
                        documentsData = documentsData.filter(d => d.codigo_documento !== documentId);
                        filteredDocuments = filteredDocuments.filter(d => d.codigo_documento !== documentId);
                        
                        updateDocumentsTable();
                        updateStatistics();
                        
                        dataManager.showNotification('success', `Documento "${doc.nome_arquivo}" excluído com sucesso.`);
                    } else {
                        errorElement.textContent = result.error || 'Erro ao excluir documento.';
                    }
                } catch (error) {
                    console.error('Erro ao excluir documento:', error);
                    errorElement.textContent = 'Erro ao processar solicitação. Tente novamente.';
                }
            });
            
            // Remover o modal do DOM quando for fechado
            document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modalContent);
            });
        }

        async function reprocessDocument(documentId) {
            const doc = documentsData.find(d => d.codigo_documento === documentId);
            if (!doc) return;

            if (confirm(`Deseja reprocessar o documento "${doc.nome_arquivo}"?`)) {
                try {
                    // Mostrar notificação de processamento
                    dataManager.showNotification('info', `Iniciando reprocessamento do documento...`);
                    
                    // Usar o endpoint correto do API_CONFIG
                    const endpoint = API_CONFIG.ENDPOINTS.DOCUMENTS_PROCESS.replace(':id', documentId);
                    
                    // Preparar dados para envio com flag de reprocessamento
                    const requestData = {
                        model: 'gpt-4',  // Modelo padrão
                        detailLevel: 'complete',  // Nível de detalhe padrão
                        forceReprocess: true  // Indicar que é um reprocessamento
                    };
                    
                    // Log para debug
                    console.log(`Reprocessando documento ${documentId} com endpoint: ${endpoint}`, requestData);
                    
                    // Fazer a requisição
                    const response = await fetch(sigataAPI.baseURL + endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMessage = 'Erro ao iniciar reprocessamento';
                        
                        try {
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.error || errorMessage;
                        } catch (e) {
                            errorMessage = errorText || errorMessage;
                        }
                        
                        throw new Error(errorMessage);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Atualizar status localmente
                        doc.status_documento = 'PROCESSANDO';
                        updateDocumentsTable();
                        updateStatistics();
                        
                        dataManager.showNotification('success', `Reprocessamento iniciado para "${doc.nome_arquivo}".`);
                        
                        // Atualizar a lista após um tempo
                        setTimeout(() => {
                            refreshDocuments();
                        }, 5000);
                    } else {
                        throw new Error(result.error || 'Erro desconhecido ao iniciar reprocessamento');
                    }
                } catch (error) {
                    console.error('Erro ao reprocessar documento:', error);
                    dataManager.showNotification('danger', `Erro ao iniciar reprocessamento: ${error.message}`);
                }
            }
        }

        async function checkProcessingStatus(documentId) {
            try {
                setTimeout(async () => {
                    const status = await sigataAPI.getDocumentStatus(documentId);
                    const doc = documentsData.find(d => d.codigo_documento === documentId);
                    
                    if (doc && status) {
                        doc.status_documento = status.status;
                        updateDocumentsTable();
                        updateStatistics();
                        
                        if (status.status === 'completed') {
                            dataManager.showNotification('success', `Processamento concluído para "${doc.nome_arquivo}".`);
                        } else if (status.status === 'processing') {
                            // Verificar novamente em 5 segundos
                            checkProcessingStatus(documentId);
                        } else if (status.status === 'error') {
                            dataManager.showNotification('danger', `Erro no processamento de "${doc.nome_arquivo}".`);
                        }
                    }
                }, 5000);
            } catch (error) {
                console.error('Erro ao verificar status:', error);
            }
        }
    </script>
</body>
</html>
